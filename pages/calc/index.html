<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
    <title></title>
</head>

<body>
    <section class="section section_1">
        <form id="first_date" class="form form-date-input">
            <div class="c-input">
                <input type="date" class="input"></input>
            </div>
            <div class="result">
                <div class="row">
                    <span id="n12" class="number"></span>
                    <span class="number transparent"></span>
                </div>
                <div class="row row-2">
                    <span id="n10" class="number"></span>
                    <span id="n11" class="number"></span>
                    <span class="number transparent"></span>
                </div>
                <div class="row">
                    <span id="n1" class="number"></span>
                    <span id="n2" class="number"></span>
                    <span id="n4" class="number"></span>
                    <span id="n7" class="number"></span>
                </div>
                <div class="row">
                    <span id="n3" class="number"></span>
                    <span id="n5" class="number"></span>
                    <span id="n8" class="number"></span>
                </div>
                <div class="row">
                    <span id="n6" class="number"></span>
                    <span id="n9" class="number"></span>
                </div>
            </div>
        </form>
        <form id="second_date" class="form form-date-input">
            <div class="c-input">
                <button type="button" class="prev">Prev</button>
                <input type="date" class="input"></input>
                <button type="button" class="next">Next</button>
            </div>
            <div class="result">
                <div class="row">
                    <span id="n12" class="number"></span>
                    <span class="number transparent"></span>
                </div>
                <div class="row row-2">
                    <span id="n10" class="number"></span>
                    <span id="n11" class="number"></span>
                    <span class="number transparent"></span>
                </div>
                <div class="row">
                    <span id="n1" class="number"></span>
                    <span id="n2" class="number"></span>
                    <span id="n4" class="number"></span>
                    <span id="n7" class="number"></span>
                </div>
                <div class="row">
                    <span id="n3" class="number"></span>
                    <span id="n5" class="number"></span>
                    <span id="n8" class="number"></span>
                </div>
                <div class="row">
                    <span id="n6" class="number"></span>
                    <span id="n9" class="number"></span>
                </div>
            </div>
        </form>
    </section>
    <section class="section section_2">
        <form id="third_date" class="form">
            <div class="result">
                <div class="row">
                    <span id="n12" class="number"></span>
                    <span class="number transparent"></span>
                </div>
                <div class="row row-2">
                    <span id="n10" class="number"></span>
                    <span id="n11" class="number"></span>
                    <span class="number transparent"></span>
                </div>
                <div class="row">
                    <span id="n1" class="number"></span>
                    <span id="n2" class="number"></span>
                    <span id="n4" class="number"></span>
                    <span id="n7" class="number"></span>
                </div>
                <div class="row">
                    <span id="n3" class="number"></span>
                    <span id="n5" class="number"></span>
                    <span id="n8" class="number"></span>
                </div>
                <div class="row">
                    <span id="n6" class="number"></span>
                    <span id="n9" class="number"></span>
                </div>
            </div>
        </form>
    </section>
    <section class="section section_3">
        <form id="fourth_date" class="form">
            <div class="result">
                <div class="row">
                    <span id="n12" class="number"></span>
                    <span class="number transparent"></span>
                </div>
                <div class="row row-2">
                    <span id="n10" class="number"></span>
                    <span id="n11" class="number"></span>
                    <span class="number transparent"></span>
                </div>
                <div class="row">
                    <span id="n1" class="number"></span>
                    <span id="n2" class="number"></span>
                    <span id="n4" class="number"></span>
                    <span id="n7" class="number"></span>
                </div>
                <div class="row">
                    <span id="n3" class="number"></span>
                    <span id="n5" class="number"></span>
                    <span id="n8" class="number"></span>
                </div>
                <div class="row">
                    <span id="n6" class="number"></span>
                    <span id="n9" class="number"></span>
                </div>
            </div>
        </form>
        <form id="fifth_date" class="form">
            <div class="result">
                <div class="row">
                    <span id="n12" class="number"></span>
                    <span class="number transparent"></span>
                </div>
                <div class="row row-2">
                    <span id="n10" class="number"></span>
                    <span id="n11" class="number"></span>
                    <span class="number transparent"></span>
                </div>
                <div class="row">
                    <span id="n1" class="number"></span>
                    <span id="n2" class="number"></span>
                    <span id="n4" class="number"></span>
                    <span id="n7" class="number"></span>
                </div>
                <div class="row">
                    <span id="n3" class="number"></span>
                    <span id="n5" class="number"></span>
                    <span id="n8" class="number"></span>
                </div>
                <div class="row">
                    <span id="n6" class="number"></span>
                    <span id="n9" class="number"></span>
                </div>
            </div>
        </form>
    </section>

    <script>
        window.addEventListener("DOMContentLoaded", (event) => {
            function calc_positions({ year, month, day }) {
                const pos1 = get_arkan(day);
                const pos2 = get_arkan(month);
                const pos3 = get_arkan(pos1 + pos2);
                const pos4 = get_arkan(sum_year(year));
                const pos5 = get_arkan(pos2 + pos4);
                const pos6 = get_arkan(pos3 + pos5);
                const pos7 = get_arkan(pos3 + pos4);
                const pos8 = get_arkan(pos2 + pos6);
                const pos9 = get_arkan(pos7 + pos8);
                const pos10 = get_arkan(pos1 - pos2);
                const pos11 = get_arkan(pos2 - pos4);
                const pos12 = get_arkan(pos10 - pos11);

                return [ pos1, pos2, pos3, pos4, pos5, pos6, pos7, pos8, pos9, pos10, pos11, pos12 ];
            }

            function set_date_to_result(positions, form) {
                const posElements = positions.map((pos, i) => {
                    const posEl = form.querySelector(`#n${i + 1}`);
                    posEl.innerText = pos;
                    return posEl;
                });

                posElements.forEach((posEl) => {
                    posEl.classList.remove('blue-upderline');
                    posEl.classList.remove('red-arrow');
                });
                
                const blue_expresions = [
                    [1,4],
                    [3,5],
                    [2,6],
                    [1,2,4],
                    [1,2,3],
                    [2,3,5],
                    [2,4,5],
                    [3,5,6],
                    [1,3,6],
                    [4,5,6],
                ];

                const red_expresions = [
                    [1,2],
                    [1,3],
                    [1,5],
                    [1,6],
                    [2,3],
                    [2,4],
                    [2,5],
                    [3,4],
                    [3,6],
                    [4,5],
                    [4,6],
                    [5,6],
                ];

                red_expresions.forEach((expresion) => {
                    const values = expresion.map((index) => positions[index - 1]);
                    
                    // check if all values are equal
                    if (new Set(values).size === 1) {
                        expresion.forEach((pos) => posElements[pos - 1].classList.add('red-arrow'));
                    }
                });

                blue_expresions.forEach((expresion) => {
                    const values = expresion.map((index) => positions[index - 1]);

                    // check if all values are equal
                    if (new Set(values).size === 1) {
                        expresion.forEach((pos) => {
                            const el = posElements[pos - 1];
                            el.classList.remove('red-arrow');
                            el.classList.add('blue-upderline');
                        });
                    }
                });
            }

            function get_arkan(count) {
                const rounded = +count % 22;
                if (rounded === 0) {
                    return 22;
                }

                if (rounded < 0) {
                    return rounded + 22;
                }

                return rounded;
            }
            function sum_year(year) {
                if (year > 22) {
                    return String(year).split('').reduce((acc, number) => +acc + +number, 0);
                }
                
                return year;
            }
            function today_data() {
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth() + 1 < 10 ? '0' + (today.getMonth() + 1) : today.getMonth() + 1;
                const day = today.getDate() < 10 ? '0' + today.getDate() : today.getDate();
                const date = `${year}-${month}-${day}`;
                return date;
            }

            const forms = document.querySelectorAll('.form-date-input');
            
            function merge_triangle(tr1, tr2) {
                const year = get_arkan(+tr1[3] + +tr2[3]);
                const month = get_arkan(+tr1[1] + +tr2[1]);
                const day = get_arkan(+tr1[0] + +tr2[0]);
                return { year, month, day };
            }

            forms.forEach((form, i) => {
                const inputDate = form.querySelector('input[type="date"]');
                const _last_date_ = localStorage.getItem(`_last_date_${i}`) ?? today_data();

                inputDate.value = _last_date_;
                const [year, month, day] = _last_date_.split('-');
                const positions = calc_positions({ year, month, day });
                set_date_to_result(positions, form);

                inputDate.addEventListener('input', (e) => {
                    const first_date_value = forms[0].querySelector('input[type="date"]').value;
                    const second_date_value = forms[1].querySelector('input[type="date"]').value;

                    localStorage.setItem(`_last_date_${i}`, e.target.value);
                    
                    calc_and_set(first_date_value, second_date_value);
                });
            });
            
            function calc_and_set(first_date_value, second_date_value) {
                let [year, month, day] = first_date_value.split('-');
                let [sec_year, sec_month, sec_day] = second_date_value.split('-');
                const positions_list = [];
                positions_list.push(calc_positions({ year, month, day }));
                positions_list.push(calc_positions({ year: sec_year, month: sec_month, day: sec_day }));
                positions_list.push(calc_positions(merge_triangle(positions_list[0], positions_list[1])));
                positions_list.push(calc_positions(merge_triangle(positions_list[0], positions_list[2])));
                positions_list.push(calc_positions(merge_triangle(positions_list[1], positions_list[2])));
                
                const forms = document.querySelectorAll('form');
                forms.forEach((form, i) => {
                    set_date_to_result(positions_list[i], form);
                });
            }

            const [ first_date, second_date ] = document.querySelectorAll('.section_1 input[type="date"]');

            calc_and_set(first_date.value, second_date.value);

            function init_date_navigation () {
                const prevBtn = document.querySelector('button.prev');
                const nextBtn = document.querySelector('button.next');

                prevBtn.addEventListener('click', (e) => {
                    const inputDate = e.target.nextElementSibling;
                    inputDate.stepDown();
                    inputDate.dispatchEvent(new Event('input'));
                });
                nextBtn.addEventListener('click', (e) => {
                    const inputDate = e.target.previousElementSibling;
                    inputDate.stepUp();
                    inputDate.dispatchEvent(new Event('input'));
                });
            }
            init_date_navigation();
        });
    </script>
</body>

</html>